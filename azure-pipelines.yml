trigger:
- main

pool:
  name: 'local'
  

variables:
  resourceGroupName: 'HelloIOR-RG'
  webAppName: 'hello-ior-webapp-$(Build.BuildId)' # Unique name per build

steps:
- powershell: |
    Write-Host "Validating index.html content..."
    if (Test-Path "index.html") {
      $content = Get-Content "index.html" -Raw
      if ($content -match "Hello iOR!") {
        Write-Host "Validation passed: 'Hello iOR!' found."
      } else {
        Write-Host "Validation failed: 'Hello iOR!' not found."
        exit 1
      }
    } else {
      Write-Host "Error: index.html not found in the current directory."
      exit 1
    }
  displayName: 'Quality Check: Validate Content'

- task: AzureCLI@2
  inputs:
    azureSubscription: 'AzureServiceConnection' # Replace with your service connection name
    scriptType: 'pscore'
    scriptLocation: 'inlineScript'
    inlineScript: |
      pwsh ./deploy-webapp.ps1 -resourceGroupName "$(resourceGroupName)" -webAppName "$(webAppName)"
  displayName: 'Provision Azure Web App'

- task: AzureWebApp@1
  inputs:
    azureSubscription: 'AzureServiceConnection' # Replace with your service connection name
    appType: 'webAppLinux'
    appName: '$(webAppName)'
    package: '$(System.DefaultWorkingDirectory)/index.html'
    deploymentMethod: 'zipDeploy'
  displayName: 'Deploy index.html to Web App'